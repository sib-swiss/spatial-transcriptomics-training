{
  "hash": "a69bc9dc292eb7efb85234394746e7a7",
  "result": {
    "markdown": "---\ntitle: \"Normalization and scaling\"\nengine: knitr\n---\n\n\nLoading the required packages:\n\n\n::: {.cell hash='3_normalization_scaling_cache/html/unnamed-chunk-1_fa7af4e3aec091535ca83f8a8646aab5'}\n\n```{.r .cell-code}\nlibrary(Seurat)\nlibrary(ggplot2)\nlibrary(clustree)\nlibrary(patchwork)\nlibrary(dplyr)\n```\n:::\n\n\nWe load the object that was output of the quality control part:\n\n\n::: {.cell hash='3_normalization_scaling_cache/html/unnamed-chunk-2_3275d000612801a0d78d2227a36e0c2c'}\n\n```{.r .cell-code}\nseu <- readRDS(\"output/seu_part2.rds\")\n```\n:::\n\n\n\n## Normalization and scaling with SCTransform\n\nBiological heterogeneity in spatial RNA-seq data is often confounded by technical factors including sequencing depth. The number of molecules detected in each spot can vary significantly between spots, even within the same celltype. Note that the variance in molecular counts/spot can be substantial for spatial datasets, particularly if there are \ndifferences in cell density across the tissue. \n\nTherefore, we apply sctransform normalization (Hafemeister and Satija, Genome Biology 2019), which builds regularized \nnegative binomial models of gene expression in order to account for technical artifacts while preserving biological variance. During the normalization, we also remove confounding sources of variation (here we take mitochondrial mapping percentage).\n\nWe need to apply `SCTransform` on each individual slice. Therefore, we split the object back into a list (with `SplitObject`). Next, we run into a small issue that both slice images are maintained in the split object, so we have keep only the image corresponding to the count table. Then, we apply `SCTransform` on the individual slices and merge the objects back together with `merge`:\n\n\n::: {.cell hash='3_normalization_scaling_cache/html/unnamed-chunk-3_e435ecd700c54634250b250984f5a858'}\n\n```{.r .cell-code}\nseu_list <- SplitObject(seu, split.by = \"orig.ident\")\n\n# preparing both objects for SCTransform\nfor(slice in names(seu_list)) {\n  \n  # images aren't split with SplitObject. Resetting the images. \n  seu_list[[slice]]@images <- setNames(\n    list(seu_list[[slice]]@images[[slice]]),\n    slice)\n  \n  # bugfix based on https://github.com/satijalab/seurat/issues/8216\n  seu_list[[slice]][[\"RNA\"]] <- seu_list[[slice]][[\"Spatial\"]]\n  DefaultAssay(seu_list[[slice]]) <- \"RNA\"\n  \n}\n\nseu_list <- lapply(X = seu_list, FUN = SCTransform, assay = \"RNA\",\n                   vars.to.regress = \"percent_mt\")\n```\n:::\n\n\n::: {.callout-important}\n## Exercise\n\nAfter running the code, to do the SCT transformation, which assays have been added to the seurat object? Note that you can get assay data with the function `Assays`.\n::: \n\n::: {.callout-tip collapse=\"true\"}\n## Answer\n\nJust by typing the object name (`seu`) we see which layers are in there:\n \n\n::: {.cell hash='3_normalization_scaling_cache/html/unnamed-chunk-4_b0b717ec0033a40af1313d803813d479'}\n\n```{.r .cell-code}\nAssays(seu_list[[1]])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"Spatial\" \"RNA\"     \"SCT\"    \n```\n:::\n:::\n\n\nShowing us that an assay called `SCT` has appeared. \n\n:::\n\nNow that we have done the transformation it is also possible to plot gene experssion information in a spatial context, e.g. `Myl4`:\n\n\n::: {.cell hash='3_normalization_scaling_cache/html/unnamed-chunk-5_a0b23d6947c54a11f446ab6dd9a08929'}\n\n```{.r .cell-code}\nSpatialPlot(seu_list$Anterior,\n            features = \"Myl4\") + \n  SpatialPlot(seu_list$Posterior, \n              features = \"Myl4\") + \n  plot_layout(guides = \"collect\") & \n  theme(legend.position = \"right\")\n```\n\n::: {.cell-output-display}\n![](3_normalization_scaling_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n::: {.callout-important}\n## Exercise\n\nCreate the same plot, but now for the gene `Calb2`. In which two parts of the brain is it primarily expressed? \n\nHint: check out [Allen Brain Atlas](http://atlas.brain-map.org/atlas?atlas=2&plate=100883804#atlas=2&plate=100884129&resolution=19.04&x=7671.818403764205&y=4000&zoom=-4&structure=549) for the names of the different parts of the brain. \n::: \n\n::: {.callout-tip collapse=\"true\"}\n## Answer\n\n\n::: {.cell hash='3_normalization_scaling_cache/html/unnamed-chunk-6_12acfe2e460be4e79f4a6ba8fee7cd05'}\n\n```{.r .cell-code}\ngene <- \"Calb2\"\nSpatialPlot(seu_list$Anterior,\n            features = gene) + \n  SpatialPlot(seu_list$Posterior, \n              features = gene) + \n  plot_layout(guides = \"collect\") & \n  theme(legend.position = \"right\")\n```\n\n::: {.cell-output-display}\n![](3_normalization_scaling_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nIt's mainly expressed in the olfactory bulb (left of the anterior slice) and cerebellum (right of the posterior slice). \n\n:::\n\nAfter quality control and transformation, we can save the output as an rds files:\n\n\n::: {.cell hash='3_normalization_scaling_cache/html/unnamed-chunk-7_a338663219d1e525624d41baa2d8132e'}\n\n```{.r .cell-code}\nsaveRDS(seu_list,\n        paste0(\"output/seu_part3.rds\"))\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}